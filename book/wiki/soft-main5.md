
#  Crazepony5.1软件结构


##软件流程图

![](/assets/img/main.jpg)

Crazepony5.1版本软件流程图总体来说大概就是这样的，Craepony主控使用的是STM32芯片，没有上任何系统使用的是裸奔，所以要依靠中断嵌套来完成整体功能。程序核心就是通过定时器中断置标志位，在主循环中通过不断查询判断各个条件，这样就产生了几个大小不一样的时间段，我们根据需要就可以完成多久扫描一次遥控器指令、多久更新一次传感器数据、多久更新一次控制等等飞控需要实现的功能，尽可能的利用主控的资源。
进入主函数之后就是处理器和各个部分的初始化了，部分初始化如下

![](/assets/img/main.png)

初始化部分首先要对处理器进行初始化，初始化系统时钟，使用的8M外部晶振，倍频到主控的最大系统运行时钟72M;
初始化系统定时器用来作为控制时间依据;初始化串口用来输出一些调试信息、上位机数据和参数配置;
初始化中断，以实现各中断的优先级;
初始化LED灯，以便输出不同的状态，给我们提供一个简单的状态判断依据;
初始化定时器2用来输出PWM控制四个电机;
初始化AD部分用来检测电池电压;
初始化IIC总线因为我们是通过IIC总线读取MPU6050传感器和气压计数据的;
初始化传感器，我们就可以读取传感数据，处理之后就可以得到飞机的姿态信息了;
初始化NRF24L01无线模块，为和遥控器进行通讯做好准备;
初始化蓝牙模块，为和我们的手机APP进行通讯讯做好准备;
初始化定时器4产生1ms中断，中断服务程序中产生了几个主循环中关键的判断依据和查询标志位，使得主循环可以合适运稳定地控制飞控;
然后就是系统需要的一些参数，变量等等的初始化，到这里系统的初始化就差不多完成了。如下图

![](/assets/img/main-init.png)

接下来就是进入主循环之中了，主循环也就是整个程序功能实现的关键，程序进入这里面就循环在里面运行了，当然中断会打断去运行中断服务程序运行玩之后再回到这里运行。主循环体中首先有if(loop200HzCnt >= 5)｛｝这个大的结构，其中loop200HzCnt这个变量是在TIM4中断服务程序中累加的，1ms累加一次，也就是说定时5ms就去完成这个下面功能，这个大if{}结构包含了整个whlie(1)下面的所有内容，在这个下面还嵌套有if(loop100HzCnt>=10)｛｝、Nrf_Irq()*接受2401数据函数*    if(loop50HzFlag)｛｝、if(loop10HzFlag)｛｝、if(pcCmdFlag)｛｝这五个大块的的结构。

程序进入if(loop200HzCnt >= 5)｛｝这个结构中首先查询if(loop100HzCnt>=10)这个条件是否成立，成立就进入if(loop100HzCnt>=10)｛｝下面完成相应功能，不成立就进入Nrf_Irq()函数查询接受2401数据。如下图


同样loop100HzCnt这个变量也是在TIM4中1ms累加的，程序进入if(loop100HzCnt>10）这个IF结构中完成了，传感器数据的获取，IMU数据的处理和PID算法输出到电机等功能，IMU的校准也是在这个里面完成的。也就是说我们定义了每10ms去读取一次MPU6050传感器和气压的数据，并进行PID算法处理融合输出到控制电机。如下图

![](/assets/img/loop100Hz.jpg)

if(loop50HzFlag)这个结构loop50HzFlag标志位是在TIM4中断中每20ms置位一次的，这里解析了收到的遥控器无线发送过来的指令，更新这些控数据给核心控制算法输出控制飞控了，我们就可以控制飞控前进后退，上升下降等等操作了。如下图

![](/assets/img/loop50Hz.jpg)

同样的思路if(loop10HzFlag)也就是以10Hz的频率去执行下面功能，在这里可以通过蓝牙向我们的手机APP传送一些飞控的姿态信息，然后查询飞控的电量没有足够的话就让飞控降落下来，查询高度啊超出可控范围也把飞控降下来，查询是否和遥控器失联啊，失联就降下飞控等等安全飞行的控制。如下图

![](/assets/img/loop10Hz.jpg)

最后就是if(pcCmdFlag)这个了，这是一个与上位机调试有关的东西，主循环查询这个标志位，标志位是由上位机发送过来的指令置位的，它主要是处理pc机发送过来的指令，PID参数读取，修改等等。
